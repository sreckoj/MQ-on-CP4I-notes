
# Using OpenShift CronJob in combination with MQ

**UNDER CONSTRUCTION**

We will investigate here the possibilities of using OpenShift CronJob to periodically obtain the information related to the QueueManager running in a pod.

As an illustration, we will periodically invoke **dmpmqcfg** command to list the current Queue Manager configuration. 

All objects in this example will be created in a namespace (project) called **mq**. This is just for an illustration - it could be any namespace. In the case of pulling images from the IBM entitled registry, we should not forget to create an entitlement key secret in the selected namespace - see [Applying your entitlement key](https://www.ibm.com/docs/en/cloud-paks/cp-integration/2022.4?topic=installing-applying-your-entitlement-key-online-installation) in the Cloud Pak for Integration documentation.

Those are the high-level steps that we are going to implement

1. Prepare a ConfigMap with a simple MQ configuration
2. Create an instance of MQ that uses this configuration
3. Manually test *dmpmqcfg* on queue manager running in pod
4. Create a service account and role binding
5. Create a ConfigMap with a job script
6. Create and run an "ordinary" OpenShift Job
7. Prepare a CronJob

## Prepare a ConfigMap with a simple MQ configuration

We will create two local queues, just to have something.

```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: mqsc-example
  namespace: mq
data:
  example1.mqsc: |
    DEFINE QLOCAL('DEV.QUEUE.1') REPLACE
    DEFINE QLOCAL('DEV.QUEUE.2') REPLACE
```

## Create QueueManager that uses this ConfigMap

Change the *spec/license/accept* to *true* (for legal reasons it is here set to *false*) and apply this YAML:

```yaml
apiVersion: mq.ibm.com/v1beta1
kind: QueueManager
metadata:
  annotations:
    com.ibm.mq/write-defaults-spec: 'false'
  name: mq-test1
  namespace: mq
spec:
  license:
    accept: false
    license: L-RJON-CJR2RX
    use: NonProduction
  queueManager:
    name: TESTQMGR
    mqsc:
    - configMap:
        name: mqsc-example
        items:
        - example1.mqsc
    resources:
      limits:
        cpu: 500m
      requests:
        cpu: 500m
    storage:
      queueManager:
        type: ephemeral
  template:
    pod:
      containers:
        - env:
            - name: MQSNOAUT
              value: 'yes'
          name: qmgr
  version: 9.3.1.0-r3
  web:
    enabled: true

```

## Manually test *dmpmqcfg* 

We can use the *oc exec* command to connect to the pod and execute *dmpmqcfg* inside the container. When we do it manually we see the pod name in the user interface. To be able to repeat the same in the script, we have to find a way to obtain the pod name.

The following command stores the correct pod name in a given variable:
```
export pod_name=`oc get pods --selector app.kubernetes.io/name=ibm-mq,app.kubernetes.io/instance=mq-test1 -o jsonpath='{.items[0].metadata.name}'`
```

Then we can use the obtained name to run *dmpmqcfg*:
```
oc exec -it $pod_name -- dmpmqcfg
```

It displays the queue manager configuration:
```
*******************************************************************************
* Script generated on 2023-01-31   at 19.32.11 
* Script generated by user 'mqm' on host 'mq-test1-ibm-mq-0' 
* Queue manager name:  
* Queue manager platform: UNIX 
* Queue manager command level: (931/931)   
* Command issued: dmpmqcfg  
*******************************************************************************
ALTER QMGR +
*  ADVCAP(ENABLED) +
*  ALTDATE(2023-01-30) +
*  ALTTIME(07.49.28) +
   CCSID(819) +
   CLWLUSEQ(LOCAL) +
...
...
...
```

## Create a service account and role bindings

Since the job will access another pod in the namespace it must have permission to do that. The easiest way is to create a service account for that job and assign the admin role to that account. We can choose whatever name for the service account. In this example, we named it *mq-batch*.

Create a service account:
```
oc create serviceaccount mq-batch -n mq
```

Create role binding:
```
oc create clusterrolebinding deletedb2-crb --clusterrole=cluster-admin --serviceaccount=mq:mq-batch
```

## Create a ConfigMap with a job script

The next step would be to prepare a script that will contain the same commands as in the manual test. We will store the script in a ConfigMap.

Apply the following YAML:

```yaml
kind: ConfigMap
apiVersion: v1
metadata:
  name: mq-cronjob-test-script
  namespace: mq
data:
  test-script.sh: |
    #!/bin/bash
    pod_name=`oc get pods --selector app.kubernetes.io/name=ibm-mq,app.kubernetes.io/instance=mq-test1 -o jsonpath='{.items[0].metadata.name}'`
    oc exec -it $pod_name -- dmpmqcfg
```

## Create and run an "ordinary" OpenShift Job

We can now create a job that runs the script. Let's create and test an "ordinary" Job in the OpenShift. In our example, we will apply a YAML with the job definition. It is also possible to create it manually through the OpenShift web console (please see the *Workloads > Jobs* and *Workloads > CronJobs* in the command left panel).  

Please note in the following YAML how the service account and ConfigMap are assigned to the job.

Since we have to run the *oc* commands in the script, we selected *quay.io/openshift/origin-cli:latest* image for the job. This is a light image that contains the *oc* CLI tools.

```yaml
apiVersion: batch/v1
kind: Job
metadata:
  name: mq-test-job
  namespace: mq
spec:
  template:
    spec:
      serviceAccountName: mq-batch
      volumes:
        - name: mq-test-script
          configMap:
            name: mq-cronjob-test-script
            defaultMode: 511
      containers:
        - name: mq-test-job
          command:
            - /scripts/test-script.sh
          imagePullPolicy: IfNotPresent
          image: 'quay.io/openshift/origin-cli:latest'
          volumeMounts:
            - name: mq-test-script
              mountPath: /scripts
      restartPolicy: OnFailure
```


## Prepare CronJob

Finally, we can transform our Job into the CronJob. We can just copy/paste the specification of our job to the CronJob's jobTemplate and add a schedule. 

It should look similar to the following example:

```yaml
apiVersion: batch/v1
kind: CronJob
metadata:
  name: mq-test-cron-job
  namespace: mq
spec:
  schedule: "50,52,54,56 * * * *"
  jobTemplate:
    spec:
      template:
        spec:
          serviceAccountName: mq-batch
          volumes:
            - name: mq-test-script
              configMap:
                name: mq-cronjob-test-script
                defaultMode: 511
          containers:
            - name: mq-test-job
              command:
                - /scripts/test-script.sh
              imagePullPolicy: IfNotPresent
              image: 'quay.io/openshift/origin-cli:latest'
              volumeMounts:
                - name: mq-test-script
                  mountPath: /scripts
          restartPolicy: OnFailure
```



































